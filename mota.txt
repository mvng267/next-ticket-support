ğŸ§© Tá»”NG QUAN CHá»¨C NÄ‚NG

á»¨ng dá»¥ng Ä‘Æ°á»£c xÃ¢y dá»±ng trÃªn ná»n táº£ng Next.js (sá»­ dá»¥ng App Router), Ä‘Ã³ng vai trÃ² nhÆ° má»™t backend xá»­ lÃ½ Ä‘á»“ng bá»™ dá»¯ liá»‡u tá»« HubSpot thÃ´ng qua API. Thay vÃ¬ sá»­ dá»¥ng Firestore, dá»¯ liá»‡u ticket sáº½ Ä‘Æ°á»£c lÆ°u trá»¯ cá»¥c bá»™ báº±ng SQLite (sá»­ dá»¥ng thÆ° viá»‡n better-sqlite3). NgoÃ i ra, frontend Ä‘Æ¡n giáº£n Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ gá»­i payload tá»« ngÆ°á»i dÃ¹ng, nháº±m Ä‘iá»u khiá»ƒn cÃ¡c hÃ nh Ä‘á»™ng cá»¥ thá»ƒ mÃ  backend sáº½ xá»­ lÃ½.

â¸»

âš™ï¸ CÃC THÃ€NH PHáº¦N CHÃNH

1. Frontend (Payload Controller)
   - Giao diá»‡n ngÆ°á»i dÃ¹ng Ä‘Æ¡n giáº£n vá»›i má»™t nÃºt báº¥m "Sync Tickets".
   - Khi ngÆ°á»i dÃ¹ng báº¥m nÃºt, frontend sáº½ gá»­i má»™t payload cÃ³ Ä‘á»‹nh dáº¡ng `{ trigger: 'sync' }` Ä‘áº¿n API route.
   - sync theo 1 ngÃ y trÆ°á»›c, 7 ngÃ y trÆ°á»›c, 30 ngÃ y trÆ°á»›c , 6 thÃ¡ng trÆ°á»›c 
   - Payload dÃ¹ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh hÃ nh Ä‘á»™ng cáº§n thá»±c hiá»‡n.

2. Backend API (Next.js API Route)
   - API route nháº­n payload tá»« frontend.
   - Náº¿u payload lÃ  `"sync"`, backend sáº½ gá»i HubSpot API (dÃ¹ng phÆ°Æ¡ng thá»©c `/crm/v3/objects/tickets/search`) Ä‘á»ƒ láº¥y danh sÃ¡ch ticket.
   - Sau khi láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u, á»©ng dá»¥ng sáº½ lÆ°u hoáº·c cáº­p nháº­t dá»¯ liá»‡u ticket vÃ o cÆ¡ sá»Ÿ dá»¯ liá»‡u SQLite.
   - TrÆ°á»›c khi thÃªm má»›i hoáº·c cáº­p nháº­t, há»‡ thá»‘ng kiá»ƒm tra xem ticket ID (`hs_ticket_id`) Ä‘Ã£ tá»“n táº¡i trong database hay chÆ°a.

3. HubSpot API Integration
   - Sá»­ dá»¥ng Bearer Token tá»« biáº¿n mÃ´i trÆ°á»ng `.env.local` Ä‘á»ƒ gá»i API.
   - Endpoint chÃ­nh: `https://api.hubapi.com/crm/v3/objects/tickets/search`
   - Dá»¯ liá»‡u Ä‘Æ°á»£c láº¥y bao gá»“m nhiá»u thuá»™c tÃ­nh quan trá»ng nhÆ° ID, subject, ngÆ°á»i táº¡o, cÃ´ng ty liÃªn quan, ná»™i dung, nguá»“n, v.v.
   - Má»™t sá»‘ thuá»™c tÃ­nh (nhÆ° `hs_ticket_category`, `support_object`, `hs_pipeline_stage`) chá»‰ cÃ³ value, cáº§n gá»i thÃªm API metadata Ä‘á»ƒ láº¥y Ä‘Æ°á»£c label tÆ°Æ¡ng á»©ng.

4. SQLite Database
   - Sá»­ dá»¥ng thÆ° viá»‡n `better-sqlite3` Ä‘á»ƒ thao tÃ¡c vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u SQLite.
   - Sá»­ dá»¥ng `sqlite3` Ä‘á»ƒ táº¡o file `.db` cá»¥c bá»™ vÃ  xá»­ lÃ½ dá»¯ liá»‡u.
   - Sá»­ dá»¥ng `@types/better-sqlite3` cho há»— trá»£ TypeScript.
   - Báº£ng chÃ­nh: `tickets`, vá»›i trÆ°á»ng `id` lÃ  `hs_ticket_id`, Ä‘Ã³ng vai trÃ² khÃ³a chÃ­nh.
   - Dá»¯ liá»‡u Ä‘Æ°á»£c kiá»ƒm tra trÃ¹ng ID trÆ°á»›c khi ghi má»›i hoáº·c cáº­p nháº­t.

â¸»

ğŸ“‚ Cáº¤U TRÃšC THÆ¯ Má»¤C Dá»° ÃN

next-ticket-support/
â”œâ”€â”€ app/                    
â”‚   â”œâ”€â”€ page.tsx            â†’ Trang chÃ­nh (hiá»ƒn thá»‹ nÃºt Sync)
â”‚   â””â”€â”€ api/hubspot/sync.ts â†’ API route xá»­ lÃ½ Ä‘á»“ng bá»™
â”œâ”€â”€ components/             
â”‚   â””â”€â”€ PayloadControls.tsx â†’ Giao diá»‡n Ä‘iá»u khiá»ƒn payload
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ hubspot.ts          â†’ HÃ m gá»i HubSpot API
â”‚   â””â”€â”€ db.ts               â†’ Xá»­ lÃ½ káº¿t ná»‘i vÃ  truy váº¥n SQLite
â”œâ”€â”€ types/                  â†’ Äá»‹nh nghÄ©a kiá»ƒu dá»¯ liá»‡u Ticket
â”œâ”€â”€ database.sqlite         â†’ File cÆ¡ sá»Ÿ dá»¯ liá»‡u SQLite
â”œâ”€â”€ .env.local              â†’ Biáº¿n mÃ´i trÆ°á»ng (API key, config)
â”œâ”€â”€ package.json
â””â”€â”€ next.config.js

â¸»

ğŸ” Báº¢O Máº¬T & BIáº¾N MÃ”I TRÆ¯á»œNG

- Má»i thÃ´ng tin nháº¡y cáº£m nhÆ° `HUBSPOT_API_KEY`, cáº¥u hÃ¬nh database... Ä‘Æ°á»£c lÆ°u trong file `.env.local`.
- Biáº¿n mÃ´i trÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng thÃ´ng qua chuáº©n Next.js (`process.env`) vÃ  khÃ´ng Ä‘Æ°á»£c Ä‘áº©y lÃªn GitHub.

â¸»

ğŸ“Œ CÃC TRÆ¯á»œNG Dá»® LIá»†U Cáº¦N Láº¤Y Tá»ª HUBSPOT

| TrÆ°á»ng                   | Ghi chÃº |
|--------------------------|--------|
| hs_ticket_id             | ID ticket (dÃ¹ng lÃ m khÃ³a chÃ­nh) |
| hs_ticket_category       | Láº¥y cáº£ `value` vÃ  `label` (cáº§n gá»i API metadata) |
| hubspot_owner_id         | Láº¥y `value`, sau Ä‘Ã³ gá»i API Ä‘á»ƒ láº¥y tÃªn ngÆ°á»i táº¡o |
| hs_primary_company_name  | Láº¥y `value` |
| subject                  | Láº¥y `value` |
| source_type              | Láº¥y `value` |
| content                  | Láº¥y `value` |
| hs_pipeline_stage        | Láº¥y `value`, cáº§n Ä‘á»‘i chiáº¿u `label` tá»« pipeline API |
| support_object           | Láº¥y `value`, cÃ³ thá»ƒ cáº§n API riÃªng Ä‘á»ƒ láº¥y label |
| create date              | NgÃ y giá» táº¡o ticket (tá»« `createdate`, ISO 8601) |

â¸»

âœ… Æ¯U ÄIá»‚M

- Dá»… dÃ ng má»Ÿ rá»™ng thÃªm cÃ¡c thao tÃ¡c backend thÃ´ng qua payload.
- TÃ¡ch biá»‡t frontend (UI) vÃ  backend (logic xá»­ lÃ½).
- Hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p, khÃ´ng cáº§n server riÃªng.
- Dá»… deploy trÃªn Vercel hoáº·c dÃ¹ng trÃªn localhost vá»›i SQLite.
- Dá»¯ liá»‡u lÆ°u trá»¯ cá»¥c bá»™ khÃ´ng phá»¥ thuá»™c cloud, tiáº¿t kiá»‡m chi phÃ­.

â¸»